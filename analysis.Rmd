---
title: "Wuhan: Seeding vs transmission"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Packages and setup

```{r}
library(bpmodels)
library(tibble)
library(dplyr)
library(tidyr)
library(lubridate)
library(purrr)
library(furrr)
```

# Scenarios and parameter sampling

* Stratify the analysis by seeding event size and duration:
  * Event size: 20, 40, 60, 80, 100
  * Event duration: 7 days, 14 days, 28 days
  * Case detection (and definition): 0.2, 0.4, 0.6, 0.8
* Sampled parameters:
  * Serial interval: 8.4 (SD: 3.8) from Lispsitch et al. (2003)
  * K: 0.16 from Lloyd-Smith (2005)
* Fitted parameters
  * R0: Uniform(0, 5) prior
* Case bounds:
  * Lower bound: 500,
  * Upper bound 4000

```{r}
## Set up scenarios
scenarios <- tidyr::expand_grid(
    event_size = c(20, 40, 60, 80, 100),
    event_duration = c(7, 14, 28)
    ) %>% 
  ## Add a scenario id
  dplyr::mutate(scenario = 1:dplyr::n())

## No. of samples
samples <- 1

## Sample paramters and set assumptions
## See https://github.com/epiforecasts/ringbp for parameter definitions
sampled_and_set_parameters <- tibble(
  sample = 1:samples,
  ## Scenario analysis parameters
  ## reproduction number
  R0  = runif(samples, min = 0, max = 4),
  ## Serial mean (normal)
  serial_mean =  8.4, ## from Lispsitch et al. (2003)
  ## Serial sd (normal)
  serial_sd =  3.8, ## from Lispsitch et al. (2003)
  ## k
  k = 0.16, ## from Lloyd-Smith (2005).
  ## This includes Amoy Gardens, which was a freak event and should probably be excluded; excluding this   would lead to a higher k
  ##Outbreak length
  outbreak_length = (lubridate::as_date(Sys.Date()) - lubridate::as_date("2019-12-31")) %>% 
    as.numeric(),
)

## Case bounds
upper_case_bound <- 4000
lower_case_bound <- 500
```

# Scenario analysis

1. Branching process from `bpmodels`.
2. Run an outbreak for each day of the assumed seeding event.
3. Summarise outbreaks across a single seeding event.

```{r}
#plan(multisession)


## Source model function
source("run_ncov_sim.R")


## Run scenarios and samples against sims
scenario_sims <- scenarios %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(sims = list(
    purrr::map(
    1:samples, 
    ~ tibble::tibble( 
        size = run_ncov_sim(
                     n = event_size,
                     n_length = event_duration,
                     mean_si = sampled_and_set_parameters$serial_mean[.x], 
                     sd_si = sampled_and_set_parameters$serial_sd[.x], 
                     R0 = sampled_and_set_parameters$R0[.x], 
                     k = sampled_and_set_parameters$k[.x], 
                     tf = sampled_and_set_parameters$outbreak_length[.x] + event_duration,
                     max_potential_cases = upper_case_bound + 1),
        sample = .x,
        R0 = sampled_and_set_parameters$R0[.x]
      )
  ))) %>% 
  dplyr::ungroup() %>% 
  tidyr::unnest(c("sims")) %>% 
  tidyr::unnest("sims")
```

# Restrict scenarios and summarise output

* Restrict potential scenarios based on an upper and lower bound of total cases.

* Summarise each outbreak across samples.


```{r}
restricted_scenarios <- scenario_sims %>% 
  dplyr::filter(size > lower_case_bound, size < upper_case_bound) %>% 
  dplyr::group_by(event_size, event_duration) %>% 
  dplyr::summarise(median_R0 = median(R0), 
                   lower_R0 = min(R0), 
                   upper_R0 = max(R0))
```

# Output

Compare R0s across scenarios (reporting only upper and lower bounds):

* Grid of event size vs event duration with R0 estimates for each comparison for each case detection.
* Grid acreas can be rejected based on?

  #### Analysis implementation

  ##### Option 1

  1. Base the branching process model on Joel's (initially Adam's) approach.
  2. Run the model for each fixed parameter scenario.
    * For each day of the seeding event, seeding the number of initial cases expected on that day
    * Run the observation model on the overall number of expected cases for each seeded outbreak
    * Summarise the overall outbreak
    * Fit R0 for the sampled outbreaks - *How should this be done?*


### Output

