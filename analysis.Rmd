---
title: "Wuhan: Seeding vs transmission"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Packages and setup

```{r}
library(ringbp)
library(tibble)
library(dplyr)
library(tidyr)
library(lubridate)
library(furrr)
```

# Scenarios and parameter sampling

* Stratify the analysis by seeding event size and duration:
  * Event size: 20, 40, 60, 80, 100
  * Event duration: 7 days, 14 days, 28 days
  * Case detection (and definition): 0.2, 0.4, 0.6, 0.8
* Sampled parameters:
  * Incubation period: 5 days (*CI needed*)
  * Generation time: 8-9 days (*CI needed*)
* Fitted parameters
  * R0: Uniform(0, 5) prior

```{r}
## Set up scenarios
scenarios <- tidyr::expand_grid(
    event_size = c(20, 40, 60, 80, 100),
    event_duration = c(7, 14, 28),
    case_detection_plus_isolation = c(0.2, 0.4, 0.6, 0.8, 1)
    ) %>% 
  ## Add daily number of cases in the seeding event - rounded for speed, should be looked at later
  dplyr::mutate(daily_cases_in_seeding = round(event_size / event_duration, 0))

## No. of samples
samples <- 10

## Sample paramters and set assumptions
## See https://github.com/epiforecasts/ringbp for parameter definitions
sampled_and_set_parameters <- tibble(
  sample = 1:samples,
  ## Scenario analysis parameters
  ## Index R0
  index_R0  = runif(samples, min = 0, max = 5),
  ## Incubation mean (sampled in model from gamma)
  incubation_mean = 9,
  ## Incubation variance (sampled in model from gamma)
  incubation_var = 7.3,
  ## Infectiousness mean (sampled in model from gamma)
  inf_mean = 5.3,
  ## Infectiosness variance (sampled in model from gamma)
  inf_var = 4.3,
  ## Parameters set from scenario analysis parameters
  max_outbreak_length = (lubridate::as_date(Sys.Date()) - lubridate::as_date("2019-12-31")) %>% 
    as.numeric(),
  ## Assumed parameters - to be looked at later 
  detected_R0 = 0,
  neg_bin_disp = 1.6,
  treatment_effectiveness = 1,
  treatment_uptake = 1
)
```
# Scenario analysis

1. Branching process from `ringbp`
2. Run an outbreak for each day of the assumed seeding event
3. Summarise outbreaks across a single seeding event

```{r}
plan(multiprocess)

scenario_sims <- scenarios %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(sims = list(
    furrr::future_map(
    1:samples, 
    ~ ringbp::wuhan_sim(n.cores = 1,
                        n.sim = 1,
                        wvaccYN = 0, 
                        define_6m = 239, 
                        initial.cases.pcluster = 1,
                        initial.clusters = daily_cases_in_seeding, 
                        prop.ascertain = case_detection_plus_isolation, 
                        cap_cases = 4500, 
                        cap_max_days = sampled_and_set_parameters$max_outbreak_length[.], 
                        r0within = sampled_and_set_parameters$detected_R0[.], 
                        r0Am = sampled_and_set_parameters$index_R0[.],
                        overkkmiss = sampled_and_set_parameters$neg_bin_disp[.],
                        overkk = 0.19, 
                        vefficacy = sampled_and_set_parameters$treatment_effectiveness[.],
                        vuptake = sampled_and_set_parameters$treatment_uptake[.],
                        ring.size = 100, 
                        time_to_protection = 10, 
                        incub_mean = sampled_and_set_parameters$incubation_mean[.], 
                        incub_var = sampled_and_set_parameters$incubation_var[.],
                        inf_mean = sampled_and_set_parameters$inf_mean[.], 
                        inf_var = sampled_and_set_parameters$inf_var[.], 
                        delay_shape = 2.4114166, 
                        delay_rate = 0.3261129,
                        time_to_isolation=1)
  ))) %>% 
  dplyr::mutate(sample = list(1:samples)) %>% 
  dplyr::ungroup() %>% 
  tidyr::unnest(c("sims", "sample")) %>% 
  tidyr::unnest("sims")
```

# Restrict scenarios

Restrict potential scenarios based on an upper and lower bound of total cases.

# Summarise analysis

Summarise each outbreak across samples. Generate:
  * Upper and lower bounds on the R0 value
  
# Output

Compare R0s across scenarios (reporting only upper and lower bounds):

* Grid of event size vs event duration with R0 estimates for each comparison for each case detection.
* Grid acreas can be rejected based on?

  #### Analysis implementation

  ##### Option 1

  1. Base the branching process model on Joel's (initially Adam's) approach.
  2. Run the model for each fixed parameter scenario.
    * For each day of the seeding event, seeding the number of initial cases expected on that day
    * Run the observation model on the overall number of expected cases for each seeded outbreak
    * Summarise the overall outbreak
    * Fit R0 for the sampled outbreaks - *How should this be done?*


### Output

