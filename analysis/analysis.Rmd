---
title: "Wuhan: Seeding vs transmission"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, message = FALSE}
library(bpmodels)
library(tibble)
library(dplyr)
library(tidyr)
library(lubridate)
library(purrr)
library(furrr)
library(knitr)
```

# Scenarios and parameter sampling

* Stratify the analysis by seeding event size and duration:
  * Event size: 20, 40, 60, 80
  * Event duration: 7 days, 14 days, 28 days
* Sampled parameters:
  * Serial interval: 8.4 (SD: 3.8) from Lispsitch et al. (2003)
  * K: 0.16 from Lloyd-Smith (2005)
* Fitted parameters
  * R0: Uniform(0, 5) prior
* Case bounds:
  * Lower bound: 780
  * Upper bound 880

```{r}

## Scenario
## All R0
#upper_R0 <- 4
## Subcritical
upper_R0 <- 1

## Set up scenarios
scenarios <- tidyr::expand_grid(
    event_size = c(20, 40, 60, 80),
    event_duration = c(7, 14, 28)
    ) %>% 
  ## Add a scenario id
  dplyr::mutate(scenario = 1:dplyr::n())

## No. of samples
samples <- 10000

## Sample paramters and set assumptions
## See https://github.com/epiforecasts/ringbp for parameter definitions
sampled_and_set_parameters <- tibble(
  sample = 1:samples,
  ## Scenario analysis parameters
  ## reproduction number
  R0  = runif(samples, min = 0, max = upper_R0),
  ## Serial mean (normal)
  #serial_mean =  8.4, ## from Lispsitch et al. (2003)
  serial_mean = 12, ## from John
  ## Serial sd (normal)
  #serial_sd =  3.8, ## from Lispsitch et al. (2003)
  serial_sd = 4,
  ## k
  k = 0.16, ## from Lloyd-Smith (2005).
  ## This includes Amoy Gardens, which was a freak event and should probably be excluded; excluding this   would lead to a higher k
  ##Outbreak length
  outbreak_length = (lubridate::as_date(Sys.Date()) - lubridate::as_date("2019-12-31")) %>% 
    as.numeric(),
)

## Case bounds
upper_case_bound <- 5000 #880
lower_case_bound <- 0 #780
```

# Scenario analysis

1. Branching process from `bpmodels`.
   * Assumes a negative binomial distribution on new cases
   * Assumes that the serial interval is gaussian distributed. 
2. Run an outbreak for each day of the assumed seeding event.
3. Summarise outbreaks across a single seeding event.

```{r}
plan(multisession)


## Source model function
source("../functions/run_ncov_sim.R")

## Source scenario analysis function
source("../functions/scenario_analysis.R")

## Run scenarios and samples against sims
scenario_sims <- scenarios %>% 
  scenario_analysis(sampled_and_set_parameters)
```

# Restrict scenarios and summarise output

* Restrict potential scenarios based on an upper and lower bound of total cases.

* Summarise each outbreak across samples.

* Report number of accepted samples per scenario.

```{r}
## Filter by number of known cases on the 2nd of January
allowed_scenarios_3rd_jan <- scenario_sims %>% 
  dplyr::filter(time == event_duration + 3, size < 60, size > 40) %>% 
  dplyr::select(sample, scenario, event_duration, event_size)

## Total allowed samples by scenario
allowed_scenarios_2nd_jan %>% 
  group_by(scenario, event_duration, event_size) %>% 
  summarise(allowed_per = dplyr::n() / samples)


## Filter by number of known cases on the 2nd of January
allowed_scenarios_20th_jan <- scenario_sims %>% 
  dplyr::filter(time == event_duration + 20, size < 240, size > 200) %>% 
  dplyr::select(sample, scenario, event_duration, event_size)

## Total allowed samples by scenario
allowed_scenarios_20th_jan %>% 
  group_by(scenario, event_duration, event_size) %>% 
  summarise(allowed_per = dplyr::n() / samples)

restricted_scenarios <- scenario_sims %>% 
  dplyr::group_by(event_size, event_duration) %>% 
  dplyr::filter(time == max(time)) %>% 
  dplyr::ungroup() %>% 
  dplyr::right_join(allowed_scenarios_3rd_jan, by = c("scenario", "sample", 
                                             "event_duration", "event_size")) %>% 
    dplyr::right_join(allowed_scenarios_20th_jan, by = c("scenario", "sample", 
                                             "event_duration", "event_size")) %>% 
  dplyr::filter(size > lower_case_bound, size < upper_case_bound) %>% 
  dplyr::group_by(event_size, event_duration) %>% 
  dplyr::summarise(median_R0 = median(R0, na.rm = TRUE), 
                   lower_R0 = min(R0, na.rm = TRUE), 
                   upper_R0 = max(R0, na.rm = TRUE),
                   samples = dplyr::n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate_at(.vars = c("median_R0", "lower_R0", "upper_R0"), ~ round(., 1)) %>% 
  dplyr::mutate(R0 = paste0(median_R0, " (", lower_R0, " - ", upper_R0, ")"))

##Samples per scenario
restricted_scenarios %>% 
  dplyr::select(event_size, event_duration, samples) %>% 
  knitr::kable()
```

# Output

Compare R0s across scenarios (reporting median, maximum and minimum):

* Grid of event size vs event duration with R0 estimates.

```{r}
source("../functions/make_duration_size_table.R")

make_duration_size_table(restricted_scenarios)
```

