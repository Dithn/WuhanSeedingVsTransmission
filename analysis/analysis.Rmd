---
title: "Wuhan: Seeding vs transmission"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, message = FALSE}
library(bpmodels)
library(tibble)
library(dplyr)
library(tidyr)
library(lubridate)
library(purrr)
library(furrr)
library(knitr)
```

# Scenarios and parameter sampling

* Stratify the analysis by seeding event size and duration:
  * Event size: 20, 40, 60, 80
  * Event duration: 7 days, 14 days, 28 days
* Sampled parameters:
  * Serial interval: 8.4 (SD: 3.8) from Lispsitch et al. (2003)
  * K: 0.16 from Lloyd-Smith (2005)
* Fitted parameters
  * R0: Uniform(0, 5) prior
* Case bounds:
  * Lower bound: 730
  * Upper bound 930

```{r}
## Set up scenarios
scenarios <- tidyr::expand_grid(
    event_size = c(20, 40, 60, 80),
    event_duration = c(7, 14, 28)
    ) %>% 
  ## Add a scenario id
  dplyr::mutate(scenario = 1:dplyr::n())

## No. of samples
samples <- 1000

## Sample paramters and set assumptions
## See https://github.com/epiforecasts/ringbp for parameter definitions
sampled_and_set_parameters <- tibble(
  sample = 1:samples,
  ## Scenario analysis parameters
  ## reproduction number
  R0  = runif(samples, min = 0, max = 5),
  ## Serial mean (normal)
  serial_mean =  8.4, ## from Lispsitch et al. (2003)
  ## Serial sd (normal)
  serial_sd =  3.8, ## from Lispsitch et al. (2003)
  ## k
  k = 0.16, ## from Lloyd-Smith (2005).
  ## This includes Amoy Gardens, which was a freak event and should probably be excluded; excluding this   would lead to a higher k
  ##Outbreak length
  outbreak_length = (lubridate::as_date(Sys.Date()) - lubridate::as_date("2019-12-31")) %>% 
    as.numeric(),
)

## Case bounds
upper_case_bound <- 930
lower_case_bound <- 730
```

# Scenario analysis

1. Branching process from `bpmodels`.
  * Assumes a negative binomial distribution on new cases
  * Assumes that the serial interval is gaussian distributed. 
2. Run an outbreak for each day of the assumed seeding event.
3. Summarise outbreaks across a single seeding event.

```{r}
plan(multisession)


## Source model function
source("../functions/run_ncov_sim.R")


## Run scenarios and samples against sims
scenario_sims <- scenarios %>% 
  dplyr::rowwise() %>% 
  dplyr::mutate(sims = list(
    furrr::future_map(
    1:samples, 
    ~ tibble::tibble( 
        size = run_ncov_sim(
                     n = event_size,
                     n_length = event_duration,
                     mean_si = sampled_and_set_parameters$serial_mean[.x], 
                     sd_si = sampled_and_set_parameters$serial_sd[.x], 
                     R0 = sampled_and_set_parameters$R0[.x], 
                     k = sampled_and_set_parameters$k[.x], 
                     tf = sampled_and_set_parameters$outbreak_length[.x] + event_duration,
                     max_potential_cases = upper_case_bound + 1),
        sample = .x,
        R0 = sampled_and_set_parameters$R0[.x]
      ), 
    .progress = FALSE
  ))) %>% 
  dplyr::ungroup() %>% 
  tidyr::unnest(c("sims")) %>% 
  tidyr::unnest("sims")
```

# Restrict scenarios and summarise output

* Restrict potential scenarios based on an upper and lower bound of total cases.

* Summarise each outbreak across samples.


```{r}
restricted_scenarios <- scenario_sims %>% 
  dplyr::filter(size > lower_case_bound, size < upper_case_bound) %>% 
  dplyr::group_by(event_size, event_duration) %>% 
  dplyr::summarise(median_R0 = median(R0), 
                   lower_R0 = min(R0), 
                   upper_R0 = max(R0)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate_at(.vars = c("median_R0", "lower_R0", "upper_R0"), ~ round(., 1)) %>% 
  dplyr::mutate(R0 = paste0(median_R0, " (", lower_R0, " - ", upper_R0, ")"))
```

# Output

Compare R0s across scenarios (reporting median, maximum and minimum):

* Grid of event size vs event duration with R0 estimates.

```{r}
restricted_scenarios %>% 
  dplyr::select(-median_R0, -lower_R0, -upper_R0) %>% 
  tidyr::spread(key = "event_duration", 
         value = "R0") %>% 
  dplyr::rename(`Seeding event size vs. Seeding event duration` = event_size) %>% 
  knitr::kable()
```

